<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Blighted to Bountiful
	</title>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
		integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
		crossorigin="" />
	<!-- Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,800;1,800&display=swap"
		rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Poppins:300" rel="stylesheet">
	<style>
		body {
			background: #ffffff;
			font-family: 'Poppins', Sans-Serif;
			/* 'Open Sans', sans-serif; */
			font-weight: 400;
		}

		h1 {
			font-weight: 650;
			Font-Family: 'Abril Fatface', Cursive;
		}

		h2 {
			font-weight: 250;
			Font-Family: 'Abril Fatface', Cursive;
		}

		p {
			line-height: 1.7rem;
			Font-Family: 'Poppins', Sans-Serif;
		}

		.headrow {
			background-color: rgba(190, 219, 196, .7);
			color: grey
		}

		.footrow {
			background-color: rgba(190, 219, 196, 0.7);
			color: grey;
			Font-Family: 'Poppins', Sans-Serif;
		}

		.about {
			background-color: rgb(230, 240, 232, 1);
			color: grey
		}

		a {
			color: rgb(207, 154, 154);
		}

		a:hover {
			color: rgb(144, 171, 199)
		}

		.dropDown {
			background-color: rgb(122, 122, 122);
		}

		#map {
			height: 80vh;
			background: #20282e;
		}

		#legend {
			font-size: 1rem;
			border-radius: 5px;
			max-width: 250px;
			font-family: 'Open Sans', sans-serif;
			background-color: rgb(122, 122, 122);
		}

		#legend span {
			width: 20px;
			height: 20px;
			float: left;
			margin: 0 10px 4px 0;
		}

		#legend label {
			font-size: 0.9rem;
		}

		#legend label:after {
			content: '';
			display: block;
			clear: both;
		}

		/* Small devices (landscape phones, 576px and up) */
		@media (min-width: 576px) {}

		/* Medium devices (tablets, 768px and up) */
		@media (min-width: 768px) {

			aside {
				height: 80vh;
			}
		}

		/* Large devices (desktops, 992px and up) */
		@media (min-width: 992px) {}

		/* Extra large devices (large desktops, 1200px and up) */
		@media (min-width: 1200px) {}
	</style>

</head>

<body>
	<div class="container-fluid">
		<header class="headrow row py-1">
			<div class="col">
				<h1>Blighted to Bountiful</h1>
				<h2>Potential Urban Gardens of Norfolk, Virginia</h2>
			</div>
		</header>

		<section class="row">
			<div class="col-md-8 col-lg-9 col-xl-9 order-md-2 px-0">
				<div id="map"></div>
			</div>
			<aside id="about" class="about col-md-4 col-lg-3 col-xl-3 order-md-1 py-2 pl-3 pr-3 overflow-auto">
				<section>
					<h3 class="py-2">The Project</h3>
					<p>Norfolk is a vibrant city within Hampton Roads. It is home to the largest naval base in the world
						as well as Old Dominion University. With a diverse mix of people, Norfolk is an eclectic region
						that offers something for everyone. Despite its large population, there is a strong sense of
						community. Its neighborhoods are much like its people, strong and diverse. Cities are constantly
						evolving, developing and planning for the future. Like other cities, development and growth have
						resulted in vacant lots scattered throughout the area. These lots are to some an eye sore, and
						to others they possess immense potential. Development is not the only concern for local
						residents. People in all areas are struggling with access to affordable, healthy food. Our
						nation faces a health epidemic. The <a target="blank"
							href="https://www.cdc.gov/nchs/products/databriefs/db360.htm">CDC reports</a> the prevalence
						of obesity among adults as 42.4% in 2017-2018. This is partly due to the low-cost and abundance
						of <a target="blank" href="https://www.publichealth.org/public-awareness/obesity/">unhealthy
							food</a>
						options. Often, it is the low-income demographic that suffers most from the negative effects
						of development and obesity. Unable to afford housing costs in less blighted communities or the
						price of healthy food options, the less fortunate in our society bears the brunt of these
						unfortunate consequences. </p>

					<p>Norfolk, like many other areas, is grappling with these issues. In 2016, the Norfolk Department
						of Public Health published the <a target="blank"
							href="https://www.norfolk.gov/DocumentCenter/View/25298/Norfolk-Community-Health-Status-42816?bidId=">
							Norfolk Community Health Status Report</a>, outlining important issues the community faces.
						They state that the 2015 unemployment rate in Norfolk was 5.6% and 20.5% of the total
						Norfolk population was living in poverty. The study cites obesity rates in Norfolk as of
						2012 and 2013 having a positive trend downward. Yet, 67.4% of adults are overweight or
						obese. </p>

					<p>While these figures may be overwhelming, they are not insurmountable. There is a growing trend
						across the
						country aimed at these very issues. Converting vacant lots into urban farms in order to provide
						fresh,
						affordable, locally grown produce to the community is becoming very popular. It is scalable,
						from
						<a target="blank" href="https://cityfarmchicago.org/">City Farm</a> in Chicago, Illinois to
						<a target="blank" href="https://www.seedleaf.org/">Seedleaf</a> in Lexington, Kentucky, urban
						farms
						are changing the cities of all sizes. Norfolk is well positioned to follow suit and make
						substantial
						health and development gains, similar to those seen in Lexington and Chicago.</p>

					<p>From the city’s website, I was able to locate a <a target="blank"
							href="https://data.norfolk.gov/Government/Mowing-Schedule-Spring-2020/hm45-fgnf">mowing
							schedule</a> for vacant lots. Using <a target="blank"
							href="https://air.norfolk.gov/#/">Norfolk AIR</a>, I was able to search property
						information for the addresses listed. From there, with the use of <a target="blank"
							href="https://norfolkgisdata-orf.opendata.arcgis.com/">Norfolk’s Open GIS Data</a>
						I was able to obtain parcel data. I then joined to the data collected from the mowing
						schedule and Norfolk AIR to the parcel boundaries using QGIS. Although this list may not
						be complete and show all city owned vacant lots, it provides a window into the overwhelming
						potential these parcels possess. </p>

					<p>From my research I have determined these vacant lots total 861,271 square feet (19.68 acres) and
						have a total land value of $6,800,200. I propose the city converts these lots into urban farms
						which will provide healthy, affordable, locally grown produce to the community as well as
						utilize otherwise empty space. In addition, these farms will require farmers to tend the crops,
						which will create new jobs. The execution of this may be handled in a couple ways. The city
						could
						retain ownership of these lots and instead of paying the costs of upkeep, they could create jobs
						and employ local citizens to farm, harvest, and sell the produce. Or, the lands could be leased
						or sold to non-profits to manage. In either scenario, the city will be able to provide healthier
						food to those who need it, as well as create new revenue streams from the sale of the land or
						the lease of the land. The newly created jobs also provide new tax revenues. Not only does this
						provide much needed healthy food to the community it will help to reduce the poverty rate by
						creating jobs. This is not an end-all-be-all solution, but it is a step in the right direction.
						A step that the community will benefit from greatly!
					</p>


					<p> <img src="images/young-salad.jpg" alt="plants" title="growing plants" alight="middle"></p>

				</section>
			</aside>
		</section>

		<footer class="footrow row py-1">
			<div class="col">
				<ul class="list-unstyled">
					<li>Authored by <a target="_blank" href="https://alexbuck328.github.io/">Alexander Buck</a></li>
					<li>Map authored June, 2020</li>
					<li>Data source: <a target="_blank" href="https://norfolkgisdata-orf.opendata.arcgis.com/">Norfolk
							Open GIS Data</a>
					</li>
				</ul>
			</div>
		</footer>
	</div>

	<!-- legend is outside of container-fluid and will be dynamically added to map -->
	<div class="py-2 px-3 ml-3 mt-3 text-white" id="legend"></div>

	<!-- ui is outside of container-fluid and will be dynamically added to map -->
	<div class="form-group mr-3 mt-3" id="dropdown-ui">

		<select class="dropDown form-control  text-white">
			<option value="norfolk_beans" selected>Beans</option>
			<option value="norfolk_bellPeppers">Bell Peppers</option>
			<option value="norfolk_broccoli">Broccoli</option>
			<option value="norfolk_cantaloupe">Cantaloupe</option>
			<option value="norfolk_cucumbers">Cucumbers</option>
			<option value="norfolk_eggplant">Eggplant</option>
			<option value="norfolk_kale">Kale</option>
			<option value="norfolk_lettuce">Lettuce</option>
			<option value="norfolk_onions">Onions</option>
			<option value="norfolk_peas">Peas</option>
			<option value="norfolk_potatoes">Potatoes</option>
			<option value="norfolk_raspberries">Raspberries</option>
			<option value="norfolk_spinach">Spinach</option>
			<option value="norfolk_squash">Squash</option>
			<option value="norfolk_strawberries">Strawberries</option>
			<option value="norfolk_tomatoes">Tomatoes</option>
		</select>
	</div>

	<!-- end ui control -->


	<!-- jQuery first, then Popper.js, then Bootstrap JS, then leaflet, then simple statistics then your JS! -->
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"
		integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
	</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
	</script>
	<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
		integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
		crossorigin=""></script>
	<script src="https://unpkg.com/simple-statistics@7.0.8/dist/simple-statistics.min.js"></script>
	<script>
		// initial Leaflet map options
		const options = {
			zoomSnap: .1,
			zoomControl: false
		}

		// create Leaflet map and apply options
		const map = L.map('map', options);
		new L.control.zoom({
			position: "bottomright"
		}).addTo(map)

		// request a basemap tile layer and add to the map
		L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
			subdomains: 'abcd',
		}).addTo(map);

		// set global variables for map layer,
		// mapped attribute, and normalizing attribute
		let attributeValue = "norfolk_parcelSF";
		const normValue = "norfolk_totalSF";


		// create object to hold legend titles
		const labels = {
			"norfolk_beans": "Bean Yield",
			"norfolk_bellPeppers": "Bell Pepper Yield",
			"norfolk_broccoli": "Broccoli Yield",
			"norfolk_cantaloupe": "Cantaloupe Yield",
			"norfolk_cucumbers": "Cucumber Yield",
			"norfolk_eggplant": "Eggplant Yield",
			"norfolk_kale": "Kale Yield",
			"norfolk_lettuce": "Lettuce Yield",
			"norfolk_onions": "Onion Yield",
			"norfolk_peas": "Pea Yield",
			"norfolk_potatoes": "Potato Yield",
			"norfolk_raspberries": "Raspberry Yield",
			"norfolk_spinach": "Spinach Yield",
			"norfolk_squash": "Squash Yield",
			"norfolk_strawberries": "Strawberry Yield",
			"norfolk_tomatoes": "Tomato Yield"
		}

		const totalSF = "861271"
		const totalYield = {
			"norfolk_beans": ".5",
			"norfolk_bellPeppers": "2",
			"norfolk_broccoli": ".4",
			"norfolk_cantaloupe": "1.5",
			"norfolk_cucumbers": "3.5",
			"norfolk_eggplant": "1.6",
			"norfolk_kale": ".5",
			"norfolk_lettuce": "1.5",
			"norfolk_onions": ".6",
			"norfolk_peas": ".5",
			"norfolk_potatoes": "1.5",
			"norfolk_raspberries": ".4",
			"norfolk_spinach": ".5",
			"norfolk_squash": "4.5",
			"norfolk_strawberries": ".8",
			"norfolk_tomatoes": "1.8"
		}

		//console.log(broccoliYield * totalSF)

		$.getJSON("data/vacantLots.geojson", function (data) {
			// jQuery method uses AJAX request for the GeoJSON data

			//call draw map and send data as parameter
			drawMap(data)

			//	console.log(data)
		});

		function drawMap(data) {
			//	console.log(data)
			// create leaflet datalayer and add to map 
			const vacantLots = L.geoJson(data, {
				// style counties with initial default path
				style: function (feature) {
					return {
						color: '#20282e',
						weight: 2,
						fillOpacity: 1,
						fillColor: '#1f78b4'
					};
				},
				// add hover and touch functionality to each layer
				onEachFeature: function (feature, layer) {
					// when mousing over a layer
					layer.on('mouseover', function () {
						// change the stroke color and bring that element to the front
						layer.setStyle({
							color: '#ff6e00'
						}).bringToFront();
					});
					// on mousing off layer
					layer.on('mouseout', function () {
						// reset the layer to the original stroke color
						layer.setStyle({
							color: '#20282e'
						});
					});
				}
			}).addTo(map);
			// fit the map's bounds and zoom level using the counties extent
			map.fitBounds(vacantLots.getBounds(), {
				padding: [18, 18] // add padding around lots
			});

			// draw the map calling a function with a variable as an argument.
			updateMap(vacantLots);

			// add UI controls
			addUi(vacantLots);

			// update the legend with the current data attribute information
			addLegend();

		}


		function updateMap(vacantLots) {

			// get the class breaks for the current attribute
			const breaks = getClassBreaks(vacantLots); // counties

			// loop through each lot layer to update the color and tooltip info
			vacantLots.eachLayer(function (layer) {

				const props = layer.feature.properties;

					console.log(props)

				//set the fill color of each layer based its normalized data value
				layer.setStyle({
					fillColor: getColor(props[attributeValue] / props[normValue], breaks)
				});

				// assemble string sequence for tooltip
				let tooltipInfo = `<b>Address:</b> ${props.norfolk_address}<br>
				<b>Owner:</b> ${props.norfolk_owner}<br>
				<b>Lot Size (AC):</b> ${props.norfolk_parcelAC} Acres<br>
				<b>Lot Size (SF):</b> ${props.norfolk_parcelSF.toLocaleString()} Square Feet<br>
				<b>Land Value:</b> $${props.norfolk_landValue.toLocaleString()}<br>
				<b>${labels[attributeValue]} (Lbs per SF):</b> ${props[attributeValue]} lbs/SF<br>
				<b>${labels[attributeValue]}:</b> ${(props[attributeValue]).toLocaleString()} lbs`

				// bind a tooltip to layer with county specific info
				layer.bindTooltip(tooltipInfo, {
					// sticky property so tooltip follows nouse
					sticky: true
				});
			});


			//update legend  ** BREAKS **
			updateLegend(breaks)


		}


		// get class breaks in data
		function getClassBreaks(vacantLots) {
			// create an empty array for storing data
			const values = [];

			// console.log(values)

			// loop through all the lots
			vacantLots.eachLayer(function (layer) {
				let value = layer.feature.properties[attributeValue] / layer.feature.properties[normValue];
				values.push(value) // push the normalized value for each layer to the array
			});
			// determine clusters
			const clusters = ss.ckmeans(values, 5);

			// console.log(clusters)

			// create an array of the lowest value within each cluster
			const breaks = clusters.map(function (cluster) {
				return [cluster[0], cluster.pop()];
			});

			// return array of arrays
			return breaks;

		}

		// get color of county
		function getColor(d, breaks) {
			// function accepts a single normalized value
			// and uses a series of conditional statements to determine which
			// color value to return to the function caller
			//	console.log(breaks)

			if (d <= breaks[0][1]) {
				return '#ffffcc';
			} else if (d <= breaks[1][1]) {
				return '#a1dab4';
			} else if (d <=
				breaks[2][1]) {
				return '#41b6c4';
			} else if (d <= breaks[3][1]) {
				return '#2c7fb8'
			} else if (d <= breaks[4][1]) {
				return '#253494'
			}
		}

		// add legend to the map
		function addLegend() {
			// create a new leaflet control object and position it top left
			const legendControl = L.control({
				position: 'topleft'
			});

			// when the legend is added to the map
			legendControl.onAdd = function () {
				// select a div element with an id attribute of legend
				const legend = L.DomUtil.get('legend');

				// disable scroll and click/touch on map when on legend
				L.DomEvent.disableScrollPropagation(legend);
				L.DomEvent.disableClickPropagation(legend);

				// return the selection to the method
				return legend;
			};
			// add the empty legend div to the map
			legendControl.addTo(map);

		}

		function updateLegend(breaks) { // ** BREAKS **
			// select the legend, add a title, begin an unordered list and assign to a variable
			const legend = $('#legend').html(`<h5>Total ${labels[attributeValue]}</h5>`);

			//	console.log(props[attributeValue] * )

			let yieldWeight = `${(totalYield[attributeValue] * totalSF).toLocaleString()} Pounds`

			legend.append(yieldWeight)



		}




		function addUi(vacantLots) {
			// create the slider control
			var selectControl = L.control({
				position: "topright"
			});

			// when control is added
			selectControl.onAdd = function () {
				// get the element with the id attribute ui-controls
				return L.DomUtil.get("dropdown-ui");

			};
			// add it to the map
			selectControl.addTo(map);

			$('#dropdown-ui select').change(function () {
				// code executed here when change event occurs
				attributeValue = this.value;

				console.log(attributeValue)

				updateMap(vacantLots);

			});

			$('select').change(function () {
				// store reference to currently selected value
				attributeValue = $(this).val();

				// call updateMap function and pass dataLayer
	     		updateMap(vacantLots)

			});

		}
	</script>
</body>

</html>